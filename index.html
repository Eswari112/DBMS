<!DOCTYPE html>
<html>
<head>
    <title>Secure Quiz</title>
    <style>
        body { font-family: Arial; }
        .warning { 
            color: red;
            font-weight: bold;
            display: none;
        }
        .question { margin-bottom: 20px; }
    </style>
</head>
<body oncontextmenu="return false;">

<h2>Secure Quiz</h2>
<p id="warning" class="warning">⚠ Cheating detected! Quiz Auto-Submitted...</p>

<!-- Login -->
<div id="loginBox">
    <h3>Login</h3>
    <input type="text" id="name" placeholder="Enter Name" required><br><br>
    <input type="password" id="regno" placeholder="Enter Register No" required><br><br>
    <button onclick="startQuiz()">Start Quiz</button>
</div>

<!-- Quiz -->
<form id="quizForm" style="display:none;">
    <div id="quizContainer"></div>
    <button type="submit">Submit</button>
</form>

<script>
let violated = false;
let startTime;

// QUESTIONS
const questions = [
    { q: "What is AI?", name: "q1" },
    { q: "Define Machine Learning.", name: "q2" },
    { q: "What is Deep Learning?", name: "q3" },
    { q: "What is a Dataset?", name: "q4" }
];

// SHUFFLE FUNCTION
function shuffle(array) {
    return array.sort(() => Math.random() - 0.5);
}

function loadQuestions() {
    const container = document.getElementById("quizContainer");
    const shuffled = shuffle([...questions]);

    shuffled.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "question";
        div.innerHTML = `
            <label>${index + 1}. ${item.q}</label><br>
            <input type="text" name="${item.name}" required><br>
        `;
        container.appendChild(div);
    });
}

// LOGIN → QUIZ START
function startQuiz() {
    const name = document.getElementById("name").value;
    const reg = document.getElementById("regno").value;

    if (name === "" || reg === "") {
        alert("Enter Login Details");
        return;
    }

    userName = name;
    userRegNo = reg;

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("quizForm").style.display = "block";

    loadQuestions();
    startTime = Date.now();
}

// GOOGLE SHEET SUBMIT FUNCTION
function submitToGoogleSheet(name, regno, score, time, status) {
    fetch("https://script.google.com/macros/s/AKfycbwyD2sfvlCYRNgztKuVL3Mmzxztatd_TwjwlW6iXb5ji5-NiF29Mr9Cdw5XzkSaUnMDww/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, regno, score, time, status })
    });
}

// FORM SUBMIT EVENT
document.getElementById("quizForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const timeTaken = Math.floor((Date.now() - startTime) / 1000);
    const finalScore = 4; // for now (you can calculate later)

    submitToGoogleSheet(userName, userRegNo, finalScore, timeTaken, "Submitted");
    alert("Quiz Submitted");
    window.location.href = "index.html";
});

// ANTI-CHEAT
document.addEventListener("visibilitychange", function () {
    if (document.hidden && !violated) {
        violated = true;
        document.getElementById("warning").style.display = "block";

        const timeTaken = Math.floor((Date.now() - startTime) / 1000);
        submitToGoogleSheet(userName, userRegNo, 0, timeTaken, "Auto-Submitted (Violation)");

        alert("Cheating Detected! Auto Submitted!");
        document.getElementById("quizForm").submit();
    }
});

</script>
</body>
</html>

// Start quiz
function startQuiz() {
    userName = document.getElementById("name").value;
    userRegNo = document.getElementById("regno").value;

    if (userName === "" || userRegNo === "") {
        alert("Enter name and register number!");
        return;
    }

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("quizForm").style.display = "block";

    loadQuestions();
    document.documentElement.requestFullscreen();
}

// CHEATING DETECTION
document.addEventListener("visibilitychange", function () {
    if (document.hidden && !violated) {
        violated = true;
        document.getElementById("warning").style.display = "block";

        alert("Cheating detected! Quiz is auto-submitted.");

        autoSubmit("Auto-Submitted (Violation)");
    }
});

// Disable actions
["copy","paste","cut","selectstart","contextmenu"].forEach(evt => {
    document.addEventListener(evt, e => e.preventDefault());
});

// Prevent leaving page
window.onbeforeunload = () => "You cannot leave the quiz!";

// SUBMIT HANDLING
document.getElementById("quizForm").addEventListener("submit", function(e) {
    e.preventDefault();
    autoSubmit("Submitted");
});

// GOOGLE SHEET SUBMISSION
function submitToGoogleSheet(name, regno, score, time, status) {
    fetch("https://script.google.com/macros/s/AKfycbwyD2sfvlCYRNgztKuVL3Mmzxztatd_TwjwlW6iXb5ji5-NiF29Mr9Cdw5XzkSaUnMDww/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            name: name,
            regno: regno,
            score: score,
            time: time,
            status: status
        })
    });
}

// FINAL SUBMIT FUNCTION
function autoSubmit(status) {
    let timeTaken = "N/A"; 
    let score = 0; // you can add auto-scoring later

    submitToGoogleSheet(userName, userRegNo, score, timeTaken, status);

    alert("Your quiz is submitted.");
    window.location.href = "index.html"; // redirect home
}
</script>

</body>
</html>
